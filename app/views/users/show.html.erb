<%= stylesheet_link_tag 'mypage', media: 'all', 'data-turbolinks-track': 'reload' %>
<div class="content-wrapper">
  <div class="header-mypage">
    <h1>ようこそ<%= @user.username %>さん</h1>
    <%= link_to 'ログアウト', destroy_user_session_path, method: :delete, class: 'logout-link' %>
  </div>

  <div class="weather-info">
    <h3>天気情報</h3>
    <% if @user.prefecture.present? %>
      <div class="weather-details">
        <p><%= @user.prefecture %>の現在の天気: <%= @weather_info %></p>
        <% case @weather_info %>
          <% when /晴れ/ %>
            <%= image_tag('sunny.png', alt: '晴れ', class: 'weather-icon') %>
          <% when /曇り/ %>
            <%= image_tag('cloudy.png', alt: '曇り', class: 'weather-icon') %>
          <% when /雨/ %>
            <%= image_tag('rain.png', alt: '雨', class: 'weather-icon') %>
          <% when /雪/ %>
            <%= image_tag('snow.png', alt: '雪', class: 'weather-icon') %>
          <% else %>
            <!-- その他の天気の場合はアイコンを表示しない -->
        <% end %>
      </div>
      <p>気温: <%= @temperature_info %></p>
    <% else %>
      <p>都道府県が設定されていません。</p>
    <% end %>
  </div>

  <!-- キーデータのハイライト -->
  <div class="key-data-highlights">
    <div class="card highlight-card">
      <div class="card-body">
        <h5 class="card-title">最も収穫量が多かった野菜</h5>
        <p class="card-text"><%= @most_harvested_vegetable %> (合計収穫量: <%= @most_harvested_amount %>kg)</p>
      </div>
    </div>
    <div class="card highlight-card">
      <div class="card-body">
        <h5 class="card-title">最大の節約が見られた月</h5>
        <p class="card-text"><%= @max_savings_month %> (節約額: <%= @max_savings_amount %>円)</p>
      </div>
    </div>
  </div>
  

  <!-- 通知履歴を表示 --> 
  <div class="notifications-history">
    <!-- この行に通知表示のタイトルを入れる -->
    <% @user.notifications.order(sent_at: :desc).limit(5).each do |notification| %>
      <div class="notification">
        <p><%= notification.message %></p>
        <p><%= notification.sent_at.strftime("%Y-%m-%d %H:%M") %></p>
      </div>
    <% end %>
  </div>

  <!-- グラフ描画領域 -->
  <div class="chart-container" id="graphContainer" style="display: none;">
    <!-- 収穫量の棒グラフのキャンバス -->
    <canvas id="harvestChart"
            data-vegetables="<%= @aggregated_harvests.map(&:vegetable_type).to_json %>"
            data-amounts="<%= @aggregated_harvests.map(&:total_amount).to_json %>">
    </canvas>
    <!-- 節約額の棒グラフのキャンバス -->
    <canvas id="savingsChart"
            data-vegetables="<%= @aggregated_harvests.map(&:vegetable_type).to_json %>"
            data-savings="<%= @aggregated_harvests.map(&:total_savings).to_json %>">
    </canvas>
  </div>

  <!-- Chart.jsとカスタムJavaScriptの読み込み -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <%= javascript_include_tag 'harvest_chart' %>
  
  <div class="button-container-mypage"> <!-- ボタンを中央に配置 -->
    <%= link_to '野菜を作る', vegetables_path, class: 'btn-vegetable-mypage' %>
    <% if @aggregated_harvests.present? %>
      <button id="toggleGraphBtn" class="btn-toggle-graph">グラフを表示</button>
    <% end %>
  </div>

</div>

<footer class="footer-mypage">
  <%= link_to 'プロフィールを編集', edit_user_path(@user), class: 'profile-edit-link-mypage' %>
</footer>
