<%= stylesheet_link_tag 'custom', media: 'all', 'data-turbolinks-track': 'reload' %>
<div class="content-wrapper">
  <div class="header-basil">
    <div class="title-container">
      <h1>バジルのスケジュール</h1>
      <div class="ghost-element"></div>
    </div>
    <%= link_to 'マイページに戻る', user_path(current_user), class: 'mypage-link' %>
    <%= link_to 'バジルの状態を分析する', analyze_image_path(vegetable_type: 'バジル'), class: 'btn btn-primary', remote: true, data: { toggle: 'modal', target: '#analyzeImageModal' } %>
  </div>

  <!-- 画像アップロードフォームのモーダル -->
  <div class="modal fade" id="analyzeImageModal" tabindex="-1" role="dialog" aria-labelledby="analyzeImageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="analyzeImageModalLabel">バジルの画像をアップロードして分析</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <%= form_with(url: analyze_image_path, local: true, multipart: true) do |form| %>
          <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
          <div class="modal-body">
            <%= form.label :image, "画像をアップロード" %>
            <%= form.file_field :image, accept: 'image/jpeg,image/png' %>
          </div>
          <div class="modal-footer">
            <%= form.submit "画像を分析する", class: 'btn btn-success' %>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">閉じる</button>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <% if flash[:notice].present? %>
    <div class="alert alert-success"><%= flash[:notice] %></div>
  <% elsif flash[:alert].present? %>
    <div class="alert alert-danger"><%= flash[:alert] %></div>
  <% end %>

  <div class="page-content">
    <%= render 'events/sowing_form', vegetable: @vegetable %>
  </div>

  <div class="event-periods">
    <h2>イベント期間</h2>
    <% @events.each do |event| %>
      <div class="event-period-details">
        <strong><%= event.name %>:</strong>
        <p>開始日：<%= event.start_date ? event.start_date.strftime("%Y-%m-%d") : '未定' %></p>
        <p>終了日：<%= event.end_date ? event.end_date.strftime("%Y-%m-%d") : '未定' %></p>
        <p>期間：<%= event.start_date && event.end_date ? (event.end_date - event.start_date).to_i : '未定' %> 日間</p>
        <p><%= event_description(event.name) %></p>
      </div>
    <% end %>
  </div>

  <div class="schedule-buttons">
    <% @events.each do |event| %>
      <%= button_tag event.name, type: 'button', class: 'btn btn-info stage-button', data: { toggle: 'modal', target: "#event#{event.id}_modal", 'event-id': event.id } %>
      <div class="modal fade" id="event<%= event.id %>_modal" tabindex="-1" role="dialog" aria-labelledby="event<%= event.id %>_label" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header modal-header-basil">
              <h5 class="modal-title" id="event<%= event.id %>_label"><%= event.name %>のアドバイス</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <!-- AJAXでアドバイスを動的に挿入 -->
            </div>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <div class="harvest-button-container">
    <%= link_to '収穫する', new_harvest_path(vegetable_type: 'バジル'), class: 'btn btn-success' %>
  </div>
</div>
